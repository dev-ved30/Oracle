

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>oracle.trainer module &mdash; oracle 1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=29a6c3e3"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            oracle
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">oracle</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">oracle.trainer module</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/source/oracle.trainer.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="module-oracle.trainer">
<span id="oracle-trainer-module"></span><h1>oracle.trainer module<a class="headerlink" href="#module-oracle.trainer" title="Link to this heading"></a></h1>
<dl class="py class">
<dt class="sig sig-object py" id="oracle.trainer.EarlyStopper">
<em class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">oracle.trainer.</span></span><span class="sig-name descname"><span class="pre">EarlyStopper</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">patience</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">min_delta</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#oracle.trainer.EarlyStopper" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<p>EarlyStopper class for monitoring validation loss and triggering early stopping during training.</p>
<dl class="py attribute">
<dt class="sig sig-object py" id="oracle.trainer.EarlyStopper.patience">
<span class="sig-name descname"><span class="pre">patience</span></span><a class="headerlink" href="#oracle.trainer.EarlyStopper.patience" title="Link to this definition"></a></dt>
<dd><p>Number of consecutive epochs with insufficient improvement allowed before stopping early.</p>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p>int</p>
</dd>
</dl>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="oracle.trainer.EarlyStopper.min_delta">
<span class="sig-name descname"><span class="pre">min_delta</span></span><a class="headerlink" href="#oracle.trainer.EarlyStopper.min_delta" title="Link to this definition"></a></dt>
<dd><p>Minimum change in validation loss to be considered an improvement.</p>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p>float</p>
</dd>
</dl>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="oracle.trainer.EarlyStopper.counter">
<span class="sig-name descname"><span class="pre">counter</span></span><a class="headerlink" href="#oracle.trainer.EarlyStopper.counter" title="Link to this definition"></a></dt>
<dd><p>Counts the number of consecutive epochs without sufficient improvement.</p>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p>int</p>
</dd>
</dl>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="oracle.trainer.EarlyStopper.min_validation_loss">
<span class="sig-name descname"><span class="pre">min_validation_loss</span></span><a class="headerlink" href="#oracle.trainer.EarlyStopper.min_validation_loss" title="Link to this definition"></a></dt>
<dd><p>The lowest validation loss observed so far.</p>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p>float</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="oracle.trainer.EarlyStopper.early_stop">
<span class="sig-name descname"><span class="pre">early_stop</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">validation_loss</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#oracle.trainer.EarlyStopper.early_stop" title="Link to this definition"></a></dt>
<dd><p>Checks if training should be stopped early based on the current validation loss.
This method compares the provided validation loss against the minimum validation loss seen so far.</p>
<blockquote>
<div><ul class="simple">
<li><p>If the validation loss is less than the minimum, it updates the minimum value and resets the counter.</p></li>
<li><p>If the validation loss exceeds the minimum by more than a specified delta, the counter increments.</p></li>
<li><p>When the counter reaches or exceeds the patience threshold, the method indicates that early stopping is warranted.</p></li>
</ul>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>validation_loss</strong> (<em>float</em>) – The current validation loss from the evaluation phase.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>True if early stopping criterion is met (i.e., the counter has reached the patience limit),
otherwise False.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>bool</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="oracle.trainer.Trainer">
<em class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">oracle.trainer.</span></span><span class="sig-name descname"><span class="pre">Trainer</span></span><a class="headerlink" href="#oracle.trainer.Trainer" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<dl class="py method">
<dt class="sig sig-object py" id="oracle.trainer.Trainer.fit">
<span class="sig-name descname"><span class="pre">fit</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">train_loader</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">val_loader</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_epochs</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">5</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#oracle.trainer.Trainer.fit" title="Link to this definition"></a></dt>
<dd><p>Train the model for a specified number of epochs.</p>
<p>This method moves the model to the designated device and iterates over the given number
of epochs. During each epoch, it trains the model on the training data and evaluates it on
the validation data. It records the training loss, validation loss, and macro F1 score, and
saves the best models based on the lowest validation loss and highest F1 score. Additionally,
the method logs metrics to an external service (e.g., Weights and Biases), updates the learning
rate scheduler, saves the loss histories, and stops training early if an early stopping condition
is met.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>train_loader</strong> (<em>DataLoader</em>) – DataLoader providing batches of training data.</p></li>
<li><p><strong>val_loader</strong> (<em>DataLoader</em>) – DataLoader providing batches of validation data.</p></li>
<li><p><strong>num_epochs</strong> (<em>int</em><em>, </em><em>optional</em>) – Number of epochs to train for. Defaults to 5.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>None</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="oracle.trainer.Trainer.log_data_in_wandb">
<span class="sig-name descname"><span class="pre">log_data_in_wandb</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">train_loss_history</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">val_loss_history</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">f1_history</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cf</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#oracle.trainer.Trainer.log_data_in_wandb" title="Link to this definition"></a></dt>
<dd><p>Logs training and validation metrics to Weights and Biases (wandb).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>train_loss_history</strong> (<em>List</em><em>[</em><em>float</em><em>]</em>) – List of training loss values recorded per epoch.</p></li>
<li><p><strong>val_loss_history</strong> (<em>List</em><em>[</em><em>float</em><em>]</em>) – List of validation loss values recorded per epoch.</p></li>
<li><p><strong>f1_history</strong> (<em>List</em><em>[</em><em>float</em><em>]</em>) – List of f1 score values recorded per epoch.</p></li>
<li><p><strong>cf</strong> (<em>Any</em>) – A configuration parameter or additional information to log.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>None</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="oracle.trainer.Trainer.save_loss_history">
<span class="sig-name descname"><span class="pre">save_loss_history</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">train_loss_history</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">val_loss_history</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">f1_history</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#oracle.trainer.Trainer.save_loss_history" title="Link to this definition"></a></dt>
<dd><p>Saves the loss and F1 score histories as NumPy binary files in the model directory.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>train_loss_history</strong> (<em>list</em><em> or </em><em>array-like</em>) – A collection of training loss values.</p></li>
<li><p><strong>val_loss_history</strong> (<em>list</em><em> or </em><em>array-like</em>) – A collection of validation loss values.</p></li>
<li><p><strong>f1_history</strong> (<em>list</em><em> or </em><em>array-like</em>) – A collection of F1 score values.</p></li>
</ul>
</dd>
</dl>
<p>Each history is converted to a NumPy array before saving.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="oracle.trainer.Trainer.save_model_in_wandb">
<span class="sig-name descname"><span class="pre">save_model_in_wandb</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#oracle.trainer.Trainer.save_model_in_wandb" title="Link to this definition"></a></dt>
<dd><p>Saves training artifacts to Weights &amp; Biases (wandb) for experiment tracking.
Each file is expected to reside in the directory specified by <cite>self.model_dir</cite>.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="oracle.trainer.Trainer.setup_training">
<span class="sig-name descname"><span class="pre">setup_training</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">alpha</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">gamma</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">lr</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">train_labels</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">val_labels</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">model_dir</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">device</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">wandb_run</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#oracle.trainer.Trainer.setup_training" title="Link to this definition"></a></dt>
<dd><p>Set up the training components for the model.
This method configures the training environment by initializing both the training and validation loss criteria,
setting up the optimizer, scheduling learning rate adjustments, and configuring early stopping. It also assigns
various parameters such as the device to use, the model directory for saving checkpoints, and the Weights &amp; Biases
run instance.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>alpha</strong> (<em>float</em>) – Hyperparameter for the training loss function to adjust the influence of the taxonomy.</p></li>
<li><p><strong>gamma</strong> (<em>float</em>) – Hyperparameter for the loss function that modulates the weighting of different classes.</p></li>
<li><p><strong>lr</strong> (<em>float</em>) – Learning rate for the optimizer.</p></li>
<li><p><strong>train_labels</strong> (<em>iterable</em>) – Labels for the training dataset, used to compute class weights in the training loss.</p></li>
<li><p><strong>val_labels</strong> (<em>iterable</em>) – Labels for the validation dataset, used to compute class weights in the validation loss.</p></li>
<li><p><strong>model_dir</strong> (<em>str</em>) – Directory path where model checkpoints and related outputs will be stored.</p></li>
<li><p><strong>device</strong> (<em>torch.device</em><em> or </em><em>str</em>) – The computing device (CPU or GPU) on which to run the model.</p></li>
<li><p><strong>wandb_run</strong> – Instance of the Weights &amp; Biases run for logging training progress.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>None</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="oracle.trainer.Trainer.train_one_epoch">
<span class="sig-name descname"><span class="pre">train_one_epoch</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">train_loader</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#oracle.trainer.Trainer.train_one_epoch" title="Link to this definition"></a></dt>
<dd><p>Train the model for one epoch.</p>
<p>This method performs a full training cycle over all batches provided by the <cite>train_loader</cite>.
For each batch, it moves the batch data to the appropriate device, converts labels into a
hierarchical one-hot encoding using the taxonomy, performs a forward pass to compute logits,
calculates the loss using the train criterion, and applies backpropagation along with an optimizer step.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>train_loader</strong> (<em>iterable</em>) – A data loader that yields batches of training data. Each batch is expected to be a
dictionary where the key ‘label’ is used to obtain the correct one-hot encoding.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The mean loss value computed over all batches during the epoch.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>float</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="oracle.trainer.Trainer.validate_one_epoch">
<span class="sig-name descname"><span class="pre">validate_one_epoch</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">val_loader</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#oracle.trainer.Trainer.validate_one_epoch" title="Link to this definition"></a></dt>
<dd><p>Performs validation for one epoch.</p>
<p>This method sets the model to evaluation mode and iterates over the validation data loader,
performing forward passes without gradient computation. It computes the loss using a specified
validation criterion and aggregates the true and predicted labels for metric calculation.
Additionally, it constructs a confusion matrix visualization and computes the macro F1 score.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>val_loader</strong> (<em>torch.utils.data.DataLoader</em>) – A data loader for the validation dataset. Each batch
should be a dictionary with a ‘label’ key among others and may include tensors that need to be
moved to the device.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>A dictionary containing:</dt><dd><ul class="simple">
<li><p>’val_loss’ (float): The average loss computed over all validation batches.</p></li>
<li><p>’macro_f1’ (float): The macro F1 score calculated using aggregated true and predicted labels.</p></li>
<li><p>’cf’ (wandb.Image): A wandb.Image object representing the confusion matrix plot.</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>dict</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>The method uses the taxonomy provided by self.taxonomy to filter and encode the labels hierarchically.</p></li>
<li><p>Leaf node indices are determined using the taxonomy’s level order traversal.</p></li>
<li><p>All computations are performed with gradients disabled using torch.no_grad().</p></li>
</ul>
</div>
</dd></dl>

</dd></dl>

</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Ved Shah.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>